[![Build Status](https://travis-ci.org/chouseknecht/adb-up-role.svg?branch=master)](https://travis-ci.org/chouseknecht/adb-up-role)

# adb-up-role

Create an [Atomic Developer Bundle (ADB)](https://github.com/projectatomic/adb-atomic-developer-bundle) virtual machine configured to work with [Ansible Container](https://github.com/ansible/ansible-container).

Performs the following tasks:

- Downloads the [OpenShift Vagrantfile](https://raw.githubusercontent.com/projectatomic/adb-atomic-developer-bundle/master/components/centos/centos-openshift-setup/Vagrantfile), and sets the OpenShift version
- Creates a new VM
- Installs require Vagrant plugins
- On the host machine adds an entry for *openshift.adb* to /etc/hosts, which points to the IP address assigned to the new VM
- Generates new client and server certificates for the Docker daemon running on the VM. Certificates are installed on the VM, and copied to the host. The new certs are created with *openshift.adb* as the server name, and the IP address as an alternate name.
- Restarts the Docker daemon on the VM
- Creates *setenv.sh*, a script you can source to configure your shell environment to use the Docker daemon running inside the new VM

As described in the Example section below, use this role by running the included playbook, [adb-up.yml](./files/adb-up.yml). 

## Using the virtual machine 

After the role executes, you will have a new VM running OpenShift and a Docker daemon. The best way to use this with Ansible Container is to source the script *setenv.sh* to point your shell environment to the Docker daemon running on the VM.

Next, run `ansible-container build` to create your project images. The new images will be local to the Docker daemon running in the VM. Then create the role to deploy the application by running `ansible-container shipit openshift --local-images`, and then run the playbook. 

...

## Prerequisites

Before you can use this role, you need to have the following installed:

- [Ansible 2.1+](https://github.com/ansible/ansible)
- Virtualbox 5.0.26+
- Vagrant 1.9.1+

You will also need *sudo* access to your local machine in order to install the *oc* client, and update */etc/hosts*.  

## Example

The best way to use this role is to create a new project directory, and then copy and run the playbook, [adb-up.yml](./files/adb-up.yml), included with the role. The following, example demonstrates this:

**NOTE**: When running the playbook, be sure to include the *--ask-sudo-pass* option. The below example reference the environment variable *ANSIBLE_ROLES_PATH*. You can also set this path using an *ansible.cfg* file. View [Ansible roles_path](http://docs.ansible.com/ansible/intro_configuration.html#roles-path), for more information.

```
# Install the role to your ANSIBLE_ROLES_PATH
$ ansible-galaxy install chouseknecht.adb-up

# Create a new project directory
$ mkdir adb 

# Set the working directory
$ cd adb

# Copy the included playbook
$ cp $ANSIBLE_ROLES_PATH/chouseknecht.adb-up/files/adb-up.yml . 

# Run the playbook
$ ansible-playbook adb-up.yml --ask-sudo-pass
```

## Role Variables



## Known issues

### Ruby gem error

If you're running on OSX (and possibly other platforms), you'll see the following message:

```
Ignoring eventmachine-1.0.9.1 because its extensions are not built.  Try: gem pristine eventmachine --version 1.0.9.1
```

This seems to be coming from the [Landrush](https://github.com/vagrant-landrush/landrush) plugin. See issue [#292](https://github.com/vagrant-landrush/landrush/issues/292). And, it seems safe to ignore. The VM runs fine, and `vagrant` commands work.

### Using service-manager to set the envirionment

If you read the ADB documentation, you'll see references to the command `vagrant service-manager env`. Do **NOT** use this command. It generates new certificates when you run it, and the certificates will not be bound to the *openshift.adb* host. They're bound to *example.com*, which works fine for the `docker` command, but breaks Ansible Container.

Rather than using service-manager, use the command `source setenv.sh`. This will execute the script generated by this role, setting the DOCKER variables in your environment to point to the Docker daemon running inside the ADB virtual machine.

## License

[Apache v2](./LICENSE)

## Author

[@chouseknecht](https://github.com/chouseknecht)
